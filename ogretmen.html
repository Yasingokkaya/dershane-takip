<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ã–ÄŸretmen Paneli</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<link rel="manifest" href="manifest.json">
    
    <link rel="icon" type="image/jpeg" href="logo.jpeg">
    
    <link rel="apple-touch-icon" href="logo.jpeg">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4e54c8">
    <style>
        /* 1. HAREKETLÄ° ARKA PLAN */
        body {
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* 2. GLASSMORPHISM (BUZLU CAM) KART TASARIMI */
        .glass-card {
            background: rgba(255, 255, 255, 0.85); /* Hafif ÅŸeffaf beyaz */
            backdrop-filter: blur(10px); /* ArkasÄ±nÄ± buzlu gÃ¶ster */
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        .navbar-glass {
            background: rgba(255, 255, 255, 0.9) !important;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        /* Form ElemanlarÄ± */
        .form-floating > .form-control,
        .form-floating > .form-select {
            border-radius: 12px;
            border: 1px solid #ddd;
            height: 60px; /* Daha yÃ¼ksek, parmak dostu */
        }
        
        .form-control:focus, .form-select:focus {
            border-color: #23a6d5;
            box-shadow: 0 0 0 0.25rem rgba(35, 166, 213, 0.25);
        }

        /* Modern Buton */
        .btn-modern {
            background: linear-gradient(45deg, #4776E6 0%, #8E54E9 100%);
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            transition: transform 0.2s;
        }
        .btn-modern:active {
            transform: scale(0.98);
        }
    </style>
</head>

<body>

    <nav class="navbar navbar-expand navbar-light navbar-glass mb-4 sticky-top">
        <div class="container-fluid px-3"> <span class="navbar-brand mb-0 h1 fw-bold text-primary" style="font-size: 1.2rem;">
                <img src="logo.jpeg" alt="Logo" width="35" height="35" class="d-inline-block align-text-top rounded-3 shadow-sm me-2">
            </span>
            
            <div class="d-flex align-items-center ms-auto">
                <span class="text-dark me-2 fw-medium small" id="navbarKullaniciAdi"></span>
                <button onclick="cikisYap()" class="btn btn-outline-danger btn-sm rounded-pill px-3">
                    <i class="bi bi-power"></i> <span class="d-none d-sm-inline">Ã‡Ä±kÄ±ÅŸ</span>
                </button>
            </div>
        </div>
    </nav>

    <div class="container pb-5">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                
                <div class="card glass-card p-4">
                    <div class="text-center mb-4">
                        <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                            <i class="bi bi-pencil-square fs-3"></i>
                        </div>
                        <h4 class="fw-bold text-dark">Ders KaydÄ± Gir</h4>
                        <p class="text-muted small">BugÃ¼n hangi derse girdiniz?</p>
                    </div>

                    <form id="dersForm">
                        
                        <input type="hidden" id="ogretmenAdi">

                        <div class="row g-3">
                            <div class="col-12">
                                <div class="form-floating">
                                    <input type="date" id="tarih" class="form-control" required>
                                    <label for="tarih">Ders Tarihi</label>
                                </div>
                            </div>

                            <div class="col-12">
                                <div class="form-floating">
                                    <select id="dersTipi" class="form-select" required>
                                        <option value="" selected disabled>SeÃ§iniz...</option>
                                        <option value="Matematik">Matematik</option>
                                        <option value="Fizik">Fizik</option>
                                        <option value="Kimya">Kimya</option>
                                        <option value="Biyoloji">Biyoloji</option>
                                        <option value="Tarih">Tarih</option>
                                        <option value="Ä°ngilizce">Ä°ngilizce</option>
                                        <option value="CoÄŸrafya">CoÄŸrafya</option>
                                        <option value="TÃ¼rk Dili ve EdebiyatÄ±">TÃ¼rk Dili ve EdebiyatÄ±</option>
                                        <option value="Birebir EtÃ¼t">Birebir EtÃ¼t</option>
                                    </select>
                                    <label for="dersTipi">Ders / BranÅŸ</label>
                                </div>
                            </div>
<div class="col-12">
                                <div class="form-floating">
                                    <select id="sinif" class="form-select" required>
    <option value="" selected disabled>SeÃ§iniz...</option>
    <option value="9. SÄ±nÄ±f">9. SÄ±nÄ±f</option>
    <option value="10. SÄ±nÄ±f">10. SÄ±nÄ±f</option>
    <option value="11. SÄ±nÄ±f">11. SÄ±nÄ±f</option>
    <option value="12. SÄ±nÄ±f">12. SÄ±nÄ±f</option>
</select>
                                    <label for="sinif">SÄ±nÄ±f</label>
                                </div>
                            </div>
                        


                            <div class="col-12">
                                <div class="form-floating">
                                    <input type="number" id="sure" class="form-control" placeholder="Saat" required min="1">
                                    <label for="sure">SÃ¼re (Saat)</label>
                                </div>
                            </div>

                            <div class="col-12">
                                <div class="form-floating">
                                    <input type="text" id="aciklama" class="form-control" placeholder="Not">
                                    <label for="aciklama">AÃ§Ä±klama (Ä°steÄŸe BaÄŸlÄ±)</label>
                                </div>
                            </div>

                            <div class="col-12 mt-4">
                                <button type="submit" class="btn btn-modern w-100 py-3 text-white shadow">
                                    Onaya GÃ¶nder ðŸš€
                                </button>
                            </div>
                        </div>

                    </form>
                </div>

            </div>
        </div>
        <div class="row justify-content-center mt-4">
            <div class="col-md-8 col-lg-6 text-center">
                
                <button onclick="gecmisiToggle()" id="btnGecmis" class="btn btn-light text-primary fw-bold shadow-sm rounded-pill px-4 py-2">
                    <i class="bi bi-clock-history"></i> Bu Ayki Derslerimi GÃ¶ster
                </button>

                <div id="gecmisAlani" class="mt-3 text-start" style="display: none;">
                    <div class="card glass-card border-0">
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover table-borderless mb-0 text-center align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="small text-muted">Tarih</th>
                                            <th class="small text-muted">SÄ±nÄ±f/Ders</th>
                                            <th class="small text-muted">Durum</th>
                                        </tr>
                                    </thead>
                                    <tbody id="gecmisTabloBody">
                                        <tr><td colspan="3" class="text-muted small py-3">YÃ¼kleniyor...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCWi2T41yWD2uQz5leN2w1v-0lk6dk_AWM",
            authDomain: "dershanetakip-34d23.firebaseapp.com",
            projectId: "dershanetakip-34d23",
            storageBucket: "dershanetakip-34d23.firebasestorage.app",
            messagingSenderId: "614841525540",
            appId: "1:614841525540:web:2851108451bb4ef0e4bfb1",
            measurementId: "G-RKQH5SZN43"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- GÃœVENLÄ°K VE GÄ°RÄ°Åž KONTROLÃœ ---
        window.addEventListener('DOMContentLoaded', () => {
            if(sessionStorage.getItem("oturum") !== "acik") {
                window.location.href = "index.html";
            } else {
                const adSoyad = sessionStorage.getItem("ad_soyad");
                document.getElementById("navbarKullaniciAdi").innerText = adSoyad;
                document.getElementById("ogretmenAdi").value = adSoyad;
                document.getElementById("tarih").valueAsDate = new Date();
            }
        });

        window.cikisYap = function() {
            sessionStorage.clear();
            window.location.href = "index.html";
        }

        // --- DERS KAYDETME Ä°ÅžLEMÄ° ---
        document.getElementById("dersForm").addEventListener("submit", async function(e) {
            e.preventDefault(); 
            const btn = document.querySelector("button[type='submit']");
            const originalText = btn.innerHTML;
            
            // Butona yÃ¼kleniyor efekti
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> GÃ¶nderiliyor...';
            btn.disabled = true;

            const ad = document.getElementById("ogretmenAdi").value;
            const tarih = document.getElementById("tarih").value;
            const ders = document.getElementById("dersTipi").value;
            const sinif = document.getElementById("sinif").value; // YENÄ°
            const sure = parseInt(document.getElementById("sure").value);
            const not = document.getElementById("aciklama").value;
            
            let anlikUcret = 0;

            try {
                // 1. Ã–ÄŸretmenin GÃ¼ncel Saat Ãœcretini Bul
                const qUser = query(collection(db, "kullanicilar"), where("ad_soyad", "==", ad));
                const userSnap = await getDocs(qUser);
                
                if(!userSnap.empty) {
                    anlikUcret = userSnap.docs[0].data().saat_ucreti || 0;
                }

                // 2. Ders KaydÄ±nÄ± VeritabanÄ±na Ekle
                await addDoc(collection(db, "ders_kayitlari"), {
                    ogretmen_adi: ad,
                    tarih: tarih,
                    ders_tipi: ders,
                    sinif: sinif,
                    sure: sure,
                    aciklama: not,
                    durum: "bekliyor",
                    birim_fiyat: parseFloat(anlikUcret),
                    toplam_tutar: sure * parseFloat(anlikUcret),
                    olusturulma_zamani: new Date()
                });

                // 3. KONFETÄ° PATLAT ðŸŽ‰ (Dinamiklik burada)
                confetti({
                    particleCount: 150,
                    spread: 70,
                    origin: { y: 0.6 }
                });

                // 4. BAÅžARILI MESAJI
                await Swal.fire({
                    position: 'center',
                    icon: 'success',
                    title: 'Harika!',
                    text: `âœ… ${sure} saatlik ders baÅŸarÄ±yla sisteme iÅŸlendi.`,
                    showConfirmButton: false,
                    timer: 2500,
                    backdrop: `rgba(0,0,123,0.1)` // Hafif bir arka plan karartmasÄ±
                });

                // Formu Temizle ve Tarihi SÄ±fÄ±rla
                const form = document.getElementById("dersForm");
                form.reset();
                if(document.getElementById("gecmisAlani").style.display === "block") {
                    dersGecmisiniGetir();
                }
                document.getElementById("tarih").valueAsDate = new Date(); // Tarihi bugÃ¼ne geri Ã§ek
                document.getElementById("ogretmenAdi").value = ad; // AdÄ± tekrar yerine koy

            } catch (error) {
                console.error("Hata: ", error);
                Swal.fire('Hata', error.message, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });
        // --- EKSÄ°K OLAN FONKSÄ°YONLAR BURAYA ---

        // 1. GÃ¶ster/Gizle Butonu Fonksiyonu
        window.gecmisiToggle = function() {
            const alan = document.getElementById("gecmisAlani");
            const btn = document.getElementById("btnGecmis");
            
            if (alan.style.display === "none") {
                alan.style.display = "block";
                btn.innerHTML = '<i class="bi bi-chevron-up"></i> Listeyi Gizle';
                dersGecmisiniGetir(); // Listeyi aÃ§Ä±nca verileri Ã§ek
            } else {
                alan.style.display = "none";
                btn.innerHTML = '<i class="bi bi-clock-history"></i> Bu Ayki Derslerimi GÃ¶ster';
            }
        }

        // 2. Verileri VeritabanÄ±ndan Ã‡eken Fonksiyon
        async function dersGecmisiniGetir() {
            const tablo = document.getElementById("gecmisTabloBody");
            const ad = document.getElementById("ogretmenAdi").value;

            // Bu ayÄ±n baÅŸÄ±nÄ± ve sonunu bul
            const bugun = new Date();
            const ayBasi = new Date(bugun.getFullYear(), bugun.getMonth(), 1).toISOString().split('T')[0];
            const aySonu = new Date(bugun.getFullYear(), bugun.getMonth() + 1, 0).toISOString().split('T')[0];

            try {
                // Sorgu: Bu Ã¶ÄŸretmenin, bu tarih aralÄ±ÄŸÄ±ndaki dersleri
                const q = query(
                    collection(db, "ders_kayitlari"),
                    where("ogretmen_adi", "==", ad),
                    where("tarih", ">=", ayBasi),
                    where("tarih", "<=", aySonu)
                );

                const snapshot = await getDocs(q);
                let html = "";

                // Verileri Tarihe GÃ¶re SÄ±rala (Yeniden Eskiye - JS ile sÄ±ralama)
                const dersler = [];
                snapshot.forEach(doc => dersler.push(doc.data()));
                dersler.sort((a, b) => new Date(b.tarih) - new Date(a.tarih));

                if (dersler.length === 0) {
                    html = '<tr><td colspan="3" class="text-muted small py-3">Bu ay henÃ¼z ders kaydÄ± yok.</td></tr>';
                } else {
                    dersler.forEach(veri => {
                        // Durum Rengi Ayarla
                        let durumRozet = "";
                        if(veri.durum === "bekliyor") durumRozet = '<span class="badge bg-warning text-dark"><i class="bi bi-hourglass-split"></i></span>';
                        else if(veri.durum === "onaylandi") durumRozet = '<span class="badge bg-success"><i class="bi bi-check-lg"></i></span>';
                        else if(veri.durum === "reddedildi") durumRozet = '<span class="badge bg-danger"><i class="bi bi-x-lg"></i></span>';

                        // Tarihi Formatla (YYYY-MM-DD -> DD.MM)
                        const tarihParca = veri.tarih.split("-");
                        const kisaTarih = `${tarihParca[2]}.${tarihParca[1]}`;

                        // SÄ±nÄ±f Bilgisi KontrolÃ¼ (BoÅŸsa - koy)
                        const sinifBilgisi = veri.sinif ? veri.sinif : "-";

                        html += `
                        <tr>
                            <td class="small fw-bold">${kisaTarih}</td>
                            <td>
                                <div class="fw-bold small text-dark">${veri.ders_tipi}</div>
                                <div class="text-muted" style="font-size: 11px;">${sinifBilgisi} â€¢ ${veri.sure} Saat</div>
                            </td>
                            <td>${durumRozet}</td>
                        </tr>`;
                    });
                }
                tablo.innerHTML = html;

            } catch (error) {
                console.error(error);
                tablo.innerHTML = '<tr><td colspan="3" class="text-danger small">Veri alÄ±namadÄ±.</td></tr>';
            }
        }
    </script>

</body>
</html>